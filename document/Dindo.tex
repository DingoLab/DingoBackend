




%  document/Dindo.tex

%% Dingo 后端 Dindo 的手册性质的文档

\documentclass{dingo}

\title{Dindo Document}

% 定义封面颜色
\definecolor{dindoblue}{rgb}{0.00,0.60,1.00}

% 定义字体颜色
\definecolor{dindowhite}{rgb}{0.93,0.93,0.93}

\titlebgcolor{dindoblue}
\titlefontcolor{dindowhite}
\version{0.0.1.0}
\coverpic{Dingo-A}
\city{西安, Xi`an}
\author{李约瀚\\qinka@live.com\\14130140331}
\begin{document}
    %封面
	\makecover
    %前言
    \section*{前言}
    这个文档是 Dingo 后端 Dindo 的文档，包括后端的大体需求说明，宏观设计说明、详细设计说明、数据库设计与实现、软件源码说明、
    软件测试说明、软件部署说明件与软件使用说明。

    后端 Dindo 使用 Haskell \footnote{\href{https://www.haskell.org}{Haskell} 是一门纯函数式的编程语言。}，与 Yesod 框架
    \footnote{\href{http://www.yesodweb.com}{Yesod} 是一个使用 Haskell作为主要语言，的 RESTful API 的WEB 应用框架。}
    编写的。同时整个后端代码中 Haskell的部分是使用 Haskell 与 \LaTeX 混排的文学编程。所以文档中有一部分为程序代码（及其说明）。

    Dindo 的名称由来是在笔者（也是主要维护者）在数学建模的校赛是，使用Lingo 是受到 Lingo 与 Lindo 的关系而起的名字。

    这个后端 依次将介绍 需求、设计、数据库设计、软件部署、软件使用与维护、Dindo代码及其说明等内容，以上是正文部分。
    附录中将会有部分术语表、维护的文档、索引、参考文档等。

    %目录
    \newpage
	\makecontent
	%% PART I
		\section{大体需求说明}
    \section{Dindo 架构设计概论}
    Dindo 是 Dingo 的核心部分之一，负责 客户端与后端的交互，同时负责 客户端与数据库的 、 客户端之间的间接交互。
    此部分将有负载均衡的大致方法、弹性计算的解决方案、后端API与服务程序分割的内容。同时还将说明后端业务流程。

    Dindo 是基于 Docker 容器上，采用微服务架构的一个 后端。所有的组件将运行与Docker 容器之中，且方便运行与公有云
    搭建的Docker 中，同时价格相对比较便宜。按照灵雀云的收费标准\cite{alauda:price}，按照北京一区（AWS）来计算。
		当不使用弹性计算中的策略，即仅当容器的大小与数量时确定不变时。
    负载均衡负载的采用一个 M 级别的容器，运行5个 L 级别的容器作为数据库，运行20个的 M 级别的容器为处理业务的核心部分。
    数据库每个容器配置100G的挂载点用于存放数据，并计划每天下载数据量有10G。按上述配置需要\footnote{一个月按 30天计算。}
    $$((20+1)*0.329+5*0.658)*24*30+10*30*0.93+0.75*100*5=7997.28$$
    每个月大致需要不到8000元的成本\footnote{当采用弹性计算时，这个成本将继续下降}。

		Dindo 开发过程依赖敏捷开发，并采用以持续集成为主的测试方式测试，同时采用持续交付的方式交付运营者。
		由于采用微服务架构、持续交付与Docker 可以使得后端的版本升级处于“无痛”状态。 微服务架构也能使的后端的业务逻辑
		分布在不同的程序（组件），也可使得后端分布上线。
    \section{均衡负载设计}
    均衡负载 采用 Nginx 作物负载均衡的软件，
    \section{弹性计算设计}
    \section{微服务架构设计}
    \section{业务流程说明}
    业务流程部分包括 后端对事件驱动型的业务处理过程，每个 API 中业务处理过程等。
    这部分的主要内容 将在 Dindo 源码及其结束的部分说明。
  %% PART II
    \section{数据库设计}

  %% PART III
  	\section{Dindo 部署说明}
		\label{sec:deploy}
			此部分主要说明 Dindo 的部署问题，包括测试、原型与最后实际运行是的部署。
			测试与原型的部署有两种方式，一种是直接运行，另一种是基于 Docker
			\footnote{基于的是 Ubuntu（Linux）原声的 Docker，暂不讨论 Mac OS X 与 Windows 下原生的 Docker。}
			。而最后运营是的部署，目前计划直接部公有云之上，利用 CaaS 服务。

			\subsection{测试部署方式}
			\label{sub:testdeploy}
				测试的部署一般适用于调试与检测。调试一方面是指后端开发时测试验证，另一方面则是指前端开发时测试使用。
				检测是如安全性测试等方面的检测。而通常运营部署通常不需要调试磨合，直接部署到 CaaS 提供商即可。

				\subsubsection{原生运行}
				\label{subs:nativetest}
					原生运行 首先要构建\footnote{Dindo 是不直接发行二进制文件的，发行的只有 Docker 镜像。}
					然后部署，最后运行。如果已获得 构建好的二进制文件，请直接跳过下面构建的过程。

					\paragraph{Windows 下构建}
						首先需要安装 \href{Haskell Platform 7.10.3 x64}{https://www.haskell.org/platform/windows.html}，
						然后克隆 \href{GitHub/DingoLab/DingoBackend}{https://github.com/DingoLab/DingoBackend} 仓库
						到本地，然后安装 stack，安装方式可参考 \href{Stack Install \& Upgrade}{https://github.com/commercialhaskell/stack/blob/master/doc/install\_and\_upgrade.md#windows}
						。安装完之后 跳转到仓库的目录：
						\begin{cmd}
							cd DingoBackend
						\end{cmd}
						然后执行构建：
						\begin{cmd}
							stack build
						\end{cmd}
						然后在 .stack_work 文件夹中某个文件夹下面的 bin 文件夹中可以找到 编译好的二进制文件
						\fotnote{为何不直接搜索。}。

					\paragraph{Linux 下的构建}
						首先安装 GHC\footnote{要求 7.10以上， 之前的版本没有测试过，无法保证可以正常编译运行。}。
						安装的方式通常通过



  	\section{Dindo 软件使用与维护说明}

    %% PART IV
    \section{Dindo 源码及说明}

    \section{Dindo 公共组件}
    这部分是关于 Dindo 的公共组件的。由于 Dingo 后端采用的微服务架构\footnote{后面随时可能会称之为 微架构 。}，不同的微服务之间，会有包括
    服务发现\footnote{目前的版本并没有开发实际的服务发现的内容，直接使用 Nginx 进行做均衡负载等。}、数据库
  \footnote{这一部分单独出来的。}、授权认证等是共用的。所以为了减少代码的重复使用，则独立出这一部分。

  \section{Dindo 数据库}

  \section{Dindo Launcher}

  \section{Dindo 微服务组件——用户管理}

  %% PART V
  \section{DIndo 测试说明}

  %附录
  \newpage
  \begin{appendix}
	  	\section{术语解释}
	  	\label{section:term}
			\begin{description}
				\item[CaaS] Container as a Server， 是指 将 容器（Docker）提供作为一种服务。
					是 云计算中的概念，与 PaaS、SaaS 等概念对等。
			\end{description}

	  	% 备忘性质的
	  	\section{Docker 中 Weave  的配置} % 参考 http://debugo.com/docker-weave/
	  	\label{section:dockerNweave}
	  	Weave 是能将Docker 中每个物理主机中的连接起来一个工具，也就是能使的 Docker 容器跨主机互联。
	  	下面是配置（安装）Weave 的Shell 脚本:
	  	\begin{shell}[caption=Weave 安装]
#!/bin/sh
wget -O /usr/local/bin/weave \
https://github.com/zettio/weave/releases/download/latest_release/weave
chmod a+x /usr/local/bin/weave
dao pull weaveworks/weave:1.5.1
dao pull weaveworks/plugin:1.5.1
dao pull weaveworks/weaveexec:1.5.1
apt-get update
apt-get install bridge-utils
dao pull weaveworks/weavedb:latest
weave launch 192.168.1.181
	  	\end{shell}
	  	运行容器需要 使用
	  	\begin{shell}
# weave run <ip> <repo>
	  	\end{shell}

	  	 \begin{thebibliography}{}
	  	 %\bibitem[显示符号]{引用标签} Book Title, Author
		\bibitem[1]{alauda:price} 灵雀云收费标准2016年5月，\href{http://www.alauda.cn/price/}{Alauda-Price}
	  	 \end{thebibliography}
  \end{appendix}

\end{document}
